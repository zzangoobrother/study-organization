## Redis(Remote Dictionary Server)

Remote → 외부  
Dictionary → java의 HashMap(Key-value)과 유사한 자료 구조  
Server → 서버  
In-memory Data Structure Server 

컴퓨터의 메인 메모리에 DB데이터와 같은 주요 데이터를 저장하고 처리하는 컴퓨팅 기술, 문자열, 해시, 목록, 집합, 정렬된 집합, 스트림 등을 지원하는 “데이터 구조 서버”, 인메모리 데이터베이스는 컴퓨터의 주 메모리에 모든 조직 또는 개인의 데이터를 저장합니다.  
인메모리 데이터베이스에 대한 데이터 분석은 보조기억장치를 사용하는 기존 데이터베이스에 비해 빠릅니다.  
이러한 보조 기억 장치에는 하드디스크 또는 솔리드 스테이트 장치(SSD)가 포함됩니다.  
컴퓨터의 중앙 처리 장치(CPU)는 주 메모리에 저장된 데이터에만 직접 접속할 수 있습니다.  
따라서 컴퓨터는 보조 기억 장치의 데이터보다 훨씬 빠르게 주 메모리의 데이터를 읽고 쓸 수 있습니다.  
이로 인해 인메모리 데이터베이스 처리 속도가 엄청나게 빠르게 됩니다.

### 인메모리 데이터베이스와 디스크 기반 데이터베이스 비교
- 기존 데이터베이스는 DB연산을 하려면 IO작업을 포함하는 디스크에서 읽기/쓰기를 필요로 합니다. 이 추가 프로세스로 하여 디스크 기반 데이터베이스의 속도가 저하됩니다. 
- 기존 디스크 기반 데이터베이스의 데이터는 영구적입니다. 인메모리 데이터베이스에서 사용되는 주 메모리는 휘발성 메모리 입니다.
- 인메모리 데이터베이스는 주 메모리에서 데이터를 무작위로 액세스하는 것이 매우 효율적이기 떄문에 저장 구조가 간단합니다.

redis는 event loop를 이용하여 요청을 수행한다. 즉, 실제 명령에 대한 작업은 커널 I/O 레벨에서 Multiplexing을 통해 처리하여 동시성을 보장한다. 따라서 유저 레벨에서는 싱글 스레드로 동작하지만, 커널 I/O 레벨에서는 스레드풀을 이용한다. 

1. multiplexing  
다수의 프로세스를 생성하지 않고도 여러 클라이언트에게 서비스를 제공할 수 있는 기술
2. 스레드 풀  
작업 처리에 사용되는 스레드를 제한된 개수만큼 정해놓고 작업 큐에 들어오는 작업들을 하나씩 스레드가 맡아 처리한다.  
![스크린샷 2023-06-28 오전 11 15 30](https://github.com/zzangoobrother/study-organization/assets/42162127/fa410513-6cf3-401e-afd1-b35778f2209d)  
작업처리가 끝난 스레드는 다시 작업 큐에서 새로운 작업을 가져와 처리한다.  
따라서 요청이 급증해도 작업 큐에서 작업이 대기하다가 작업 처리를 완료한 스레드가 다음 작업을 처리하므로 스레드의 전체 개수는 일정하고 애플리케이션의 성능도 저하되지 않는다.

### Memory Hierarchy(메모리 계층)
![스크린샷 2023-06-28 오전 11 17 46](https://github.com/zzangoobrother/study-organization/assets/42162127/56bdd34a-135f-4ae9-86dc-4e28cf96ff9c)  

## Redis 주요기능
### 캐싱
캐시는 한번 읽어온 데이터를 임의의 공간에 저장하여 다음에 읽을 때는 빠르게 결과값을 받을 수 있도록 도와준다.  
같은 요청이 여러번 들어오더라도 매번 DB를 거치는 것이 아니라 캐시 서버에서 최초 요청 이후 저장된 결과값을 바로 응답하기 때문에 DB의 부하를 줄이고 서비스의 속도도 느려지지 않는다는 장점이 있다.  
캐시 서버는 Look aside cache 패턴과 Write Back 패턴이 존재합니다.  

#### Look aside cache
1. 클라이언트가 데이터를 요청
2. 웹 서버는 데이터가 존재하는지 캐시 서버에 먼저 확인
3. 캐시 서버에 데이터가 존재 시 DB에 접근하지 않고 캐시 서버에 있는 값을 클라이언트에게 바로 반환(cache hit)
4. 캐시 서버에 데이터가 존재하지 않을 시 DB에서 데이터를 조회하여 캐시 서버에 저장하고 결과를 클라이언트에게 반환(cache miss)

#### Write Back
1. 웹 서버는 모든 데이터를 캐시 서버에 저장
2. 캐시 서버에 특정 시간동안 데이터가 저장됨
3. 캐시 서버에 있는 데이터를 DB에 저장
4. DB에 저장된 캐시 서버의 데이터를 삭제  

-> 이 방식은 들어오는 데이터들이 저장되기 전에 메모리 공간에 머무르는데 이 때 서버에 장애가 발생하여 다운된다면 데이터가 손실될 수 있음

### Replication - 복제
redis의 데이터를 거의 실시간으로 다른 redis 노드에 복사하는 작업으로 failover상황에 대비할 수 있다. 따라서 서비스를 제공하던 redis 노드(master)가 다운되더라도, 데이터를 받은 redis 노드(slaves)가 서비스를 계속할 수 있다.  
통상 master는 Read/write 전용이고, slave는 master의 데이터를 미러링하고 있는 Read전용이다.
- Redis-Master : 실제 데이터를 저장하는 서버
- Redis-Slave : 실제 데이터를 복사하여 전달받는 서버

![스크린샷 2023-06-28 오전 11 23 11](https://github.com/zzangoobrother/study-organization/assets/42162127/22fe624a-b6b4-4561-b5fb-82580294428b)

### Persistence  - 디스크 저장
redis는 데이터를 디스크에 저장하지 않고 메모리에 저장하기 때문에 **데이터 유실 가능성**이 높다. 이런 문제를 해결하기 위해 메모리에 저장된 데이터를 디스크로 백업하는 기능을 지원하는데 **AOF/RDB**방식이 있다.

#### Persistence-AOF(Append Only File)
AOF방식은 입력, 수정, 삭제 명령이 실행될 때마다 LOG파일에 저장하게 되며, 서버가 재시작될 때 LOG파일 의 기록된 데이터를 실행하여 데이터를 복구할 수 있다.
1. 장정
  - 실시간 데이터 저장
  - 데이터 저장 속도 빠름
  - 복원 데이터 정보 수정 가능
2. 단점
  - 로그파일의 크기 증가
  - 데이터 복구 소요시간

#### Persistence-RDB
운영 중인 데이터를 압축된 크기로 저장하는 방식  
1. 장점
  - 데이터의 크기 작음
  - 데이터 복구 속도 빠름
2. 단점
  - 실시간 데이터 백업 어려움(운영 중인 전체 데이터를 시스템 관리자가 지정한 시간에 백업)
  - 데이터 백업 속도 느림
  - 데이터 손실 우려(데이터 백업 중 서버가 다운되면 데이터 유실)

-> AOF는 데이터 손실을 최소화하는 경우 사용되며, RDB는 장애 발생 시 짧은 시간에 데이터 손실이 발생하여도 될 경우 사용

### Pub/Sub
메세지 브로커의 역할
- 메세지 브로커
서버로부터 메세지를 받아서, 비동기적으로 클라이언트에게 안전하게 전달해주는 역할을 하는 미들웨어

보통의 경우 서버로부터 메세지를 전달 받아 큐에 보관한 뒤, 알맞는 클라이언트에게 전달해주는 메세지 큐(Message Queue)구조의 메세지 브로커가 사용된다.  
redis도 메세지 브로커로서의 기능을 가지지만, 메세지 큐와는 조금 다르다. 메세지 큐는 메세지를 큐에 저장한 뒤 이를 전송하지만, Redis는 저장하지 않고, 클라이언트에게 메세지를 전달한 후 이를 바로 삭제한다.

### Redis 자료구조

![스크린샷 2023-06-28 오후 1 01 17](https://github.com/zzangoobrother/study-organization/assets/42162127/e8b7adae-9063-4818-ad49-6c55ce84103b)

#### Strings
- 텍스트, 직렬화된 객체 및 이진 배열을 포함한 바이트 시퀀스를 저장한다.
- 문자열은 가장 기본적인 Redis 데이터 유형으로 key-value 구조를 가진다.
[직렬화/역직렬화]  
자바 시스템 내부에서 사용되는 객체 또는 데이터를 외부의 자바 시스템에서도 사용할 수 있도록 바이트(byte)형태로 데이터 변환하는 기술
역직렬화 : 바이트로 변환된 데이터를 다시 객체로 변환하는 기술

#### Lists
- String element의 모음, 순서는 삽입된 순서를 유지하며 기본적인 자료구조로 Linked List를 사용

#### Sets
- 고유한 문자열의 정렬되지 않은 모음이다.

#### Hashes
- 내부에 Key-value구조를 하나 더 가지고 있다.

#### Sorted sets
- Sets 자료구조에 score를 추가로 기록하여 scor가 낮은 순서부터 높은 순서대로 정렬되는 자료구조

#### Streams
- Redis 5.0 에서 Log나 IoT 신호와 같이 지속적으로 빠르게 발생하는 데이터를 처리하기 위해서 도입된 자료구조

#### Geospatial indexes
- Redis 3.2에 새로 도입된 기능으로, 도시의 경도(lon)와 위도(lat)를 이용하여 여러 위치 정보를 활용할 수 있다.

#### Bitmaps
- 문자열을 비트 벡터처럼 처리할 수 있는 문자열 데이터 타입의 확장

#### Bitfields
- 정수형 데이터를 비트 단위로 나누어서 사용할 수 있는 기능 제공

#### HyperLogLog
- 유일한 원소 개수 추정에 사용하는 확률적 자료구조

## Redis 주의사항
서버가 여러 대인 경우 Consistency의 문제 발생  
Single Thread 서버이므로 시간 복잡도를 고려해야 한다.   
In-memory 특성 상 메모리 파편화, 가상 메모리에 대한 이해가 필요하다.  
#### 메모리 파편화
Ram에서 메모리의 공간이 작은 조각으로 나뉘어져 사용가능한 메모리가 충분히 존재하지만 할당(사용)이 불가능한 상태

+ <a href='https://zdnet.co.kr/view/?no=20131119174125' target='_blank' >static</a>
